<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI IDS — Camera Monitor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body{font-family:Arial, Helvetica, sans-serif;background:#0b0c10;color:#fff;text-align:center;padding:20px}
    h1{color:#66fcf1}
    .controls{margin:12px}
    button{padding:10px 18px;border-radius:8px;border:none;background:#45a29e;color:#000;cursor:pointer;margin:6px}
    #videoFrame{border-radius:8px;border:3px solid #071426;max-width:80%;height:auto}
    #logs{max-width:900px;margin:18px auto;text-align:left;background:#111;padding:12px;border-radius:8px}
    .log-row{padding:6px;border-bottom:1px solid #222}
    .attack{color:#ff6b6b;font-weight:700}
    .normal{color:#9be7b3}
  </style>
</head>
<body>
  <h1>AI IDS — Camera Monitor</h1>

  <div class="controls">
    <button id="startBtn">Start Camera Detection</button>
    <button id="stopBtn">Stop Camera Detection</button>
  </div>

  <div>
    <img id="videoFrame" src="/static/latest.jpg" alt="live frame (updates)" />
  </div>

  <div id="logs">
    <h3>Live Logs</h3>
    <div id="logContainer"></div>
  </div>

  <script>
    let pollInterval = null;
    async function fetchLogs() {
      try {
        const res = await fetch('/api/logs');
        const logs = await res.json();
        const container = document.getElementById('logContainer');
        container.innerHTML = '';
        logs.forEach(l => {
          const div = document.createElement('div');
          div.className = 'log-row ' + (l.intrusion_type && l.intrusion_type.toLowerCase() !== 'normal' ? 'attack' : 'normal');
          div.innerHTML = `[${l.ts_readable}] <b>${l.device}</b> → ${l.intrusion_type}`;
          container.appendChild(div);
        });
        // refresh image (bypass cache)
        const img = document.getElementById('videoFrame');
        img.src = '/static/latest.jpg?ts=' + Date.now();
      } catch (e) {
        console.error(e);
      }
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
      await fetch('/start_camera');
      // start polling logs & image
      if (!pollInterval) pollInterval = setInterval(fetchLogs, 1000);
      fetchLogs();
    });

    document.getElementById('stopBtn').addEventListener('click', async () => {
      await fetch('/stop_camera');
      if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
    });

    // optional: poll even before starting so page shows DB entries
    fetchLogs();
    pollInterval = setInterval(fetchLogs, 3000);
  </script>
</body>
</html>
